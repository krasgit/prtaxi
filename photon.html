<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>OSM + Photon Autocomplete Multiple Inputs</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin:0; font-family: sans-serif; }
        #map { height: 60vh; width: 100%; }
        .input-container { margin: 10px; position: relative; max-width: 400px; }
        input { width: 100%; padding: 8px; font-size: 14px; }
        ul.suggestions {
            list-style: none; padding: 0; margin: 0;
            border: 1px solid #ccc; max-height: 150px; overflow-y: auto;
            position: absolute; width: 100%; background: white; z-index: 1000;
        }
        ul.suggestions li { padding: 5px; cursor: pointer; }
        ul.suggestions li:hover { background: #f0f0f0; }
    </style>
</head>
<body>

<div class="input-container">
    <input type="text" class="address-input" placeholder="Адрес 1" />
    <ul class="suggestions"></ul>
</div>
<div class="input-container">
    <input type="text" class="address-input" placeholder="Адрес 2" />
    <ul class="suggestions"></ul>
</div>
<div class="input-container">
    <input type="text" class="address-input" placeholder="Адрес 3" />
    <ul class="suggestions"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([42.7, 23.3], 7); // център в България

// Добавяне на OSM tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Массив за маркери
const markers = [];

// Настройка на autocomplete за едно поле
function setupAutocomplete(input) {
    const suggestions = input.nextElementSibling;

    input.addEventListener('input', async () => {
        const query = input.value;
        if (!query) {
            suggestions.innerHTML = '';
            return;
        }

        const url = `/photon/api/?q=${encodeURIComponent(query)}&limit=5`;
        const res = await fetch(url);
        const data = await res.json();

        suggestions.innerHTML = '';
        data.features.forEach(feature => {
            const li = document.createElement('li');
            li.textContent = feature.properties.name + ', ' + (feature.properties.city || '');

            li.addEventListener('click', () => {
                input.value = li.textContent;
                suggestions.innerHTML = '';

                const [lon, lat] = feature.geometry.coordinates;
                console.log('Избрани координати за', input.placeholder, ':', lat, lon);
                handleCoordinates(input.placeholder, lat, lon);
            });

            suggestions.appendChild(li);
        });
    });
}

// Функция за работа с координатите
function handleCoordinates(field, lat, lon) {
    // Добавяме маркер на картата
    const marker = L.marker([lat, lon]).addTo(map)
        .bindPopup(`${field}: ${lat.toFixed(5)}, ${lon.toFixed(5)}`)
        .openPopup();

    markers.push(marker);

    // Преместваме картата към новия маркер
    map.setView([lat, lon], 12);
}

// Инициализиране на всички input полета
document.querySelectorAll('.address-input').forEach(input => setupAutocomplete(input));
</script>

</body>
</html>
